<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Dino Exam Escape - Randomized</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        :root {
            --g-blue: #4285F4;
            --g-red: #DB4437;
            --g-yellow: #F4B400;
            --g-green: #0F9D58;
            --bg-color: #f7f7f7;
            --text-color: #535353;
        }

        body {
            font-family: 'VT323', 'Courier New', monospace;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            user-select: none;
        }

        /* Dino Decor */
        .decoration {
            position: absolute;
            font-size: 2rem;
            opacity: 0.5;
            z-index: -1;
        }
        .cloud { top: 10%; animation: float 20s linear infinite; }
        .c1 { left: 10%; } .c2 { left: 60%; animation-delay: -10s; }
        
        @keyframes float {
            0% { transform: translateX(-100px); }
            100% { transform: translateX(100vw); }
        }

        .ground-line {
            position: fixed;
            bottom: 50px;
            width: 100%;
            height: 2px;
            background: #535353;
            z-index: -1;
        }

        /* Main Container */
        .game-container {
            width: 90%;
            max-width: 900px;
            background: #fff;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 0 #e0e0e0;
            position: relative;
            text-align: center;
            border-top: 5px solid var(--g-blue);
            min-height: 600px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* Password HUD (Small top display) */
        .password-hud {
            background: #333;
            color: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            align-self: center;
        }
        
        .hud-slot {
            width: 30px;
            height: 40px;
            border: 2px dashed #777;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--g-yellow);
            transition: all 0.3s;
        }
        
        .hud-slot.filled {
            border-style: solid;
            background: #444;
            transform: scale(1.1);
        }

        /* Puzzle Styles */
        .puzzle-display {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            min-height: 100px;
        }

        .puzzle-slot {
            width: 60px;
            height: 80px;
            border-bottom: 5px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: bold;
            color: var(--g-blue);
            cursor: pointer;
            background: #fafafa;
        }

        .puzzle-bank {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 30px;
        }

        .puzzle-letter {
            width: 60px;
            height: 60px;
            background: #333;
            color: var(--g-yellow);
            font-size: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 5px 0 #000;
            transition: transform 0.1s;
        }
        
        .puzzle-letter:active {
            transform: translateY(4px);
            box-shadow: 0 0 0;
        }

        /* Letter Acquired Modal */
        .letter-modal {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            animation: fadeIn 0.3s;
        }
        
        .big-letter {
            font-size: 10rem;
            color: var(--g-blue);
            text-shadow: 5px 5px 0px #eee;
            animation: bounce 1s infinite alternate;
        }

        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-20px); } }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px dashed #ddd;
            padding-bottom: 15px;
            width: 100%;
        }
        .timer { font-size: 2.2rem; color: var(--text-color); font-weight: bold;}

        /* Questions */
        .level-badge {
            display: inline-block;
            padding: 8px 15px;
            color: white;
            font-size: 1.4rem;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .bg-blue { background: var(--g-blue); }
        .bg-red { background: var(--g-red); }
        .bg-yellow { background: var(--g-yellow); }
        .bg-green { background: var(--g-green); }

        .question-text {
            font-size: 2.4rem; /* Big font for readability */
            margin: 30px 0;
            line-height: 1.4;
            font-weight: 500;
            color: #222;
        }

        /* Inputs & Buttons */
        input[type="text"] {
            font-family: 'VT323', monospace;
            font-size: 2rem;
            padding: 15px;
            width: 80%;
            border: 3px solid #ccc;
            border-radius: 8px;
            text-align: center;
            outline: none;
            text-transform: lowercase;
        }
        
        #start-player-name {
            text-transform: none; 
            margin-bottom: 20px;
            border-color: var(--g-blue);
        }

        input[type="text"]:focus {
            border-color: var(--g-blue);
        }

        .btn {
            font-family: 'VT323', monospace;
            font-size: 1.8rem;
            padding: 15px 40px;
            border: none;
            cursor: pointer;
            border-radius: 8px;
            margin: 10px;
            transition: transform 0.1s;
            box-shadow: 0 5px 0 rgba(0,0,0,0.2);
        }
        .btn:active { transform: translateY(4px); box-shadow: 0 0 0; }
        
        .btn-next {
            background-color: var(--g-blue);
            color: white;
            display: none;
            margin-top: 30px;
        }
        
        .btn-opt {
            background-color: #f1f3f4;
            color: #333;
            display: block;
            width: 100%;
            margin: 15px 0;
            padding: 20px;
            text-align: left;
            font-size: 1.8rem; /* Large options */
            border: 2px solid transparent;
            border-radius: 8px;
        }
        .btn-opt:hover { 
            background-color: #e8eaed; 
            border-color: #ccc;
        }

        /* Rearrange */
        .word-bank, .drop-zone {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            min-height: 80px;
            padding: 15px;
            margin: 20px 0;
        }
        .drop-zone { border-bottom: 3px solid var(--text-color); background-color: #fafafa; }
        .word-chip {
            background: #fff;
            border: 2px solid var(--text-color);
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1.6rem;
            border-radius: 5px;
            box-shadow: 0 3px 0 #ccc;
        }
        .word-chip:hover { background: #eee; transform: translateY(-2px); }
        .word-chip:active { transform: translateY(0); box-shadow: 0 0 0; }

        /* Speaking */
        .mic-box {
            font-size: 5rem;
            cursor: pointer;
            margin: 30px;
            transition: transform 0.2s;
            display: inline-block;
            background: #fff;
            border-radius: 50%;
            width: 100px;
            height: 100px;
            line-height: 100px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .mic-box:active { transform: scale(0.9); }
        .recording { animation: pulse 1s infinite; color: var(--g-red); box-shadow: 0 0 20px var(--g-red); }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        
        .speaking-result-box {
            font-family: sans-serif;
            font-size: 1.4rem;
            margin-top: 20px;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
            min-height: 80px;
        }

        /* Screens */
        .screen { display: none; }
        .active { display: block; }

        /* Admin - Subtle Style */
        .admin-toggle {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.05); /* Extremely faint */
            color: #ccc; 
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            border: none;
            z-index: 100;
            transition: all 0.3s;
        }
        .admin-toggle:hover { 
            background: rgba(0, 0, 0, 0.8); 
            color: #fff;
        }

        .admin-panel {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98);
            z-index: 999;
            overflow-y: auto;
            padding: 40px;
            box-sizing: border-box;
            font-family: sans-serif;
        }
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        .admin-card {
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
            background: white;
            cursor: pointer;
        }
        .admin-card:hover { border-color: var(--g-blue); background: #f0f8ff; }

        /* Leaderboard */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-family: sans-serif; font-size: 1.2rem; }
        th, td { padding: 12px; border-bottom: 1px solid #ddd; text-align: center; }
        th { background: var(--g-yellow); color: #333; }

    </style>
</head>
<body>

    <!-- Decorations -->
    <div class="decoration cloud c1">‚òÅÔ∏è</div>
    <div class="decoration cloud c2">‚òÅÔ∏è</div>
    <div class="ground-line">
        <span style="position: absolute; right: 10%; bottom: 0; font-size: 40px;">üåµ</span>
        <span style="position: absolute; right: 16%; bottom: 0; font-size: 25px;">üåµ</span>
        <span style="position: absolute; left: 15%; bottom: 0; font-size: 40px;">ü¶ñ</span>
    </div>

    <!-- Main Game Container -->
    <div class="game-container">
        
        <!-- Header -->
        <div class="header">
            <div id="level-indicator">START</div>
            <div class="password-hud">
                <span style="font-size: 1.2rem; margin-right: 10px;">LETTERS:</span>
                <div id="hud-container" style="display:flex; gap:5px;">
                    <!-- HUD slots injected by JS based on password length -->
                </div>
            </div>
            <div class="timer" id="timer">00:00</div>
        </div>

        <!-- Start Screen -->
        <div id="screen-start" class="screen active">
            <h1 style="font-size: 3rem; margin-bottom: 10px;">ü¶ñ DINO EXAM ESCAPE</h1>
            <p style="font-size: 1.5rem; color: #666;">Collect scattered letters to find the secret password!</p>
            
            <div style="margin: 40px 0;">
                <p style="font-size: 1.5rem;">Enter Your Name:</p>
                <input type="text" id="start-player-name" placeholder="Name / Â∫ßËôüÂßìÂêç">
            </div>

            <button class="btn bg-blue" style="color:white" onclick="startGame()">START GAME</button>
        </div>

        <!-- Question Screen -->
        <div id="screen-game" class="screen">
            <div id="game-content"></div>
        </div>

        <!-- Letter Reward Modal -->
        <div id="letter-modal" class="letter-modal">
            <h2>üéâ YOU FOUND A LETTER!</h2>
            <div id="reward-letter" class="big-letter">?</div>
            <p style="font-size: 1.5rem; color: #555;">Keep it safe!</p>
            <button class="btn bg-yellow" onclick="closeLetterModal()">CONTINUE</button>
        </div>

        <!-- Final Puzzle Screen -->
        <div id="screen-puzzle" class="screen">
            <h2>üß© FINAL CHALLENGE</h2>
            <p style="font-size: 1.4rem;">Unscramble your collected letters to unlock the door!</p>
            
            <!-- Target Slots -->
            <div class="puzzle-display" id="final-slots">
                <!-- Injected by JS -->
            </div>

            <p style="font-size: 1.2rem; color: #777;">Tap letters to place them:</p>

            <!-- Letter Bank -->
            <div class="puzzle-bank" id="final-bank">
                <!-- Injected by JS -->
            </div>
            
            <div style="margin-top: 30px;">
                <button class="btn bg-red" style="color:white" onclick="resetPuzzle()">RESET</button>
            </div>
        </div>

        <!-- End Screen -->
        <div id="screen-end" class="screen">
            <h1 style="color: var(--g-green); font-size: 4rem;">MISSION COMPLETE</h1>
            <h2 id="final-player-name" style="color: #333; font-size: 2.5rem;"></h2>
            <p style="font-size: 2rem;">Time: <span id="final-time"></span></p>
            
            <div style="border: 4px dashed var(--text-color); padding: 30px; margin: 30px 0; background: #fffbe6;">
                <p style="font-size: 1.5rem;">PASSWORD UNLOCKED:</p>
                <h1 id="final-password-display" style="font-size: 5rem; color: var(--g-blue); margin: 0; letter-spacing: 10px;"></h1>
            </div>

            <button class="btn bg-yellow" onclick="location.reload()">PLAY AGAIN</button>

            <div id="leaderboard">
                <h3>üèÜ HALL OF FAME</h3>
                <table id="lb-table"></table>
            </div>
        </div>

    </div>

    <!-- Admin Button (Subtle) -->
    <button class="admin-toggle" onclick="openAdmin()">Teacher</button>

    <!-- Admin Panel -->
    <div id="admin-panel" class="admin-panel">
        <div style="max-width: 800px; margin: 0 auto;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>üë©‚Äçüè´ Teacher Dashboard</h2>
                <button class="btn bg-red" style="color:white; font-size: 1rem;" onclick="closeAdmin()">CLOSE</button>
            </div>
            
            <p style="color: #666; font-style: italic;">Current Password: <span id="admin-pwd-display" style="font-weight:bold; color:red;"></span></p>
            
            <h3 style="border-bottom: 2px solid var(--g-blue);">Level 1: Vocab</h3>
            <div class="admin-grid" id="admin-l1"></div>

            <h3 style="border-bottom: 2px solid var(--g-red);">Level 2: Grammar</h3>
            <div class="admin-grid" id="admin-l2"></div>

            <h3 style="border-bottom: 2px solid var(--g-yellow);">Level 3: Rearrange</h3>
            <div class="admin-grid" id="admin-l3"></div>

            <h3 style="border-bottom: 2px solid var(--g-green);">Level 4: Speaking</h3>
            <div class="admin-grid" id="admin-l4"></div>
            
            <br>
            <div class="admin-card" style="background-color: #e8f5e9; border-color: var(--g-green); text-align:center; padding: 20px;" onclick="startFinalPuzzle()">
                <b>üèÅ Skip to Final Puzzle</b>
            </div>
        </div>
    </div>

<script>
    // --- QUESTION DATA POOL ---
    // Note: To make game "random" each time, we shuffle these arrays at start.
    const vocabPool = [
        { q: "When little babies cry, they usually do so to catch their parents‚Äô a________n.", a: "attention" },
        { q: "The news of Jack‚Äôs death s________d quickly, and soon everyone knew it.", a: "spread" },
        { q: "I read some a________les about the new department store in today‚Äôs newspapers.", a: "articles" },
        { q: "Ms. Huang asked her students to d________s the meaning of the ending scene.", a: "discuss" },
        { q: "Sabrina has a busy s________l life. She gets invitations to parties every weekend.", a: "social" },
        { q: "Mary has a close r________p with her grandpa. She always tells him everything.", a: "relationship" },
        { q: "If there are free bus rides, people can take a________ge of it to save time.", a: "advantage" },
        { q: "Our team worked hard to a________ve a good result.", a: "achieve" },
        { q: "Modern t________y makes us able to make phone calls through the Internet.", a: "technology" },
        { q: "The pretty girl sitting next to Frank looks f________r to me, but I am not sure about her name.", a: "familiar" }
    ];

    const grammarPool = [
        { q: "Not only Gina but also her father ________ French fries.", opts: ["liking", "likes", "liked"], a: "likes" },
        { q: "Drinking and Eating ________ not allowed on Taipei MRT.", opts: ["are", "be", "is"], a: "are" }, 
        { q: "Please ________ behind the line, or you might get hurt.", opts: ["staying", "stayed", "stay"], a: "stay" },
        { q: "Taking a hot bath ________ me relax.", opts: ["help", "helps", "to helping"], a: "helps" },
        { q: "On my birthday, my mom bought ________.", opts: ["me a PS4", "a PS4 me", "me for a PS4"], a: "me a PS4" },
        { q: "Ted forgot to bring his key, and ended up ________ at the hotel.", opts: ["staying", "stayed", "stay"], a: "staying" },
        { q: "________ eat too much fast food because it‚Äôs not good for health.", opts: ["Don‚Äôt let‚Äôs", "Let‚Äôs not", "Let‚Äôs don‚Äôt"], a: "Let‚Äôs not" },
        { q: "The old man gave ________ after I helped him cross the street.", opts: ["me to a smile", "me a smile", "a smile me"], a: "me a smile" },
        { q: "We are not allowed ________ our own food to the movie theater.", opts: ["bring", "to bring", "to bringing"], a: "to bring" },
        { q: "I overslept that morning, and I ended up ________ the train.", opts: ["miss", "missing", "to miss", "missed"], a: "missing" } 
    ];

    const rearrangePool = [
        { 
            chunks: ["I", "Not only", "Mary", "but also", "am", "study abroad", "going to"], 
            correct: "Not only Mary but also I am going to study abroad", 
            hint: "Not only A but also B..."
        },
        { 
            chunks: ["you", "when", "Give me a call", "arrive home"],
            correct: "Give me a call when you arrive home",
            hint: "Imperative Sentence"
        },
        { 
            chunks: ["his wife", "Daniel", "a ring", "as her birthday gift", "buy", "is going to"],
            correct: "Daniel is going to buy his wife a ring as her birthday gift",
            hint: "S + be going to + V..."
        },
        { 
            chunks: ["Reading", "is like", "a wonderful trip", "a good book", "taking"],
            correct: "Reading a good book is like taking a wonderful trip",
            hint: "Gerund as Subject"
        },
        { 
            chunks: ["Amber", "me", "showed", "her new phone case"],
            correct: "Amber showed me her new phone case",
            hint: "S + V + IO + DO"
        }
    ];

    const speakingPool = [
        { text: "Paul often takes advantage of his height to block other people's shots in basketball games" },
        { text: "I hit the cockroach as soon as it appeared" },
        { text: "Having spicy hotpot in the winter is awesome" },
        { text: "Let's get our red envelopes" },
        { text: "After this designer achieved success, his design style became a popular trend" }
    ];

    // --- RANDOM PASSWORD SYSTEM ---
    const PASSWORD_OPTIONS = ["ENGLISH", "SUCCESS", "VICTORY"];
    let CURRENT_PASSWORD = ""; 
    let TARGET_LETTERS = []; // e.g., ["E", "N", "G", "L", "I", "S", "H"]
    
    // --- GAME STATE ---
    let levels = []; // Will be populated with shuffled questions
    let currentLvlIdx = 0;
    let currentQIdx = 0;
    let timerInterval;
    let startTime;
    let timeElapsed = 0;
    let currentPlayerName = "Guest";
    let recognition;
    
    let collectedLetters = []; 
    let puzzleInput = [];
    let puzzleBank = []; 
    
    // Triggers for letter rewards. 
    // We have 4 levels. We need to distribute password letters across them.
    // L1: 25% | L2: 25% | L3: 25% | L4: 25% approx
    let rewardTriggers = {}; // format: "lvlIdx-qIdx": "Letter"

    // --- INIT ---
    function init() {
        initSpeech();
        // Setup random game
        setupRandomGame();
        renderHUD();
    }

    function setupRandomGame() {
        // 1. Pick a random password
        CURRENT_PASSWORD = PASSWORD_OPTIONS[Math.floor(Math.random() * PASSWORD_OPTIONS.length)];
        TARGET_LETTERS = CURRENT_PASSWORD.split('');
        
        // 2. Shuffle questions in each pool
        const shuffledVocab = shuffleArray([...vocabPool]);
        const shuffledGrammar = shuffleArray([...grammarPool]);
        const shuffledRearrange = shuffleArray([...rearrangePool]);
        const shuffledSpeaking = shuffleArray([...speakingPool]);

        // 3. Construct Levels
        levels = [
            { type: 'vocab', color: 'bg-blue', title: 'LEVEL 1', questions: shuffledVocab },
            { type: 'grammar', color: 'bg-red', title: 'LEVEL 2', questions: shuffledGrammar },
            { type: 'rearrange', color: 'bg-yellow', title: 'LEVEL 3', questions: shuffledRearrange },
            { type: 'speaking', color: 'bg-green', title: 'LEVEL 4', questions: shuffledSpeaking }
        ];

        // 4. Distribute letters randomly across questions
        // Total questions = 10 + 10 + 5 + 5 = 30 questions.
        // We need to place TARGET_LETTERS.length (7) rewards.
        rewardTriggers = {};
        let availableSlots = [];
        
        // Let's force at least 1 letter per level to ensure pacing
        // L1 slots: 0-9
        availableSlots.push({l:0, q: Math.floor(Math.random()*10)});
        // L2 slots: 0-9
        availableSlots.push({l:1, q: Math.floor(Math.random()*10)});
        // L3 slots: 0-4
        availableSlots.push({l:2, q: Math.floor(Math.random()*5)});
        // L4 slots: 0-4
        availableSlots.push({l:3, q: Math.floor(Math.random()*5)});

        // Remaining letters placement
        let remainingLetterCount = TARGET_LETTERS.length - 4;
        for(let i=0; i<remainingLetterCount; i++) {
            // Random level, random Q
            let l = Math.floor(Math.random()*4);
            let qMax = levels[l].questions.length;
            let q = Math.floor(Math.random()*qMax);
            availableSlots.push({l:l, q:q});
        }

        // Shuffle the letters we need to give out
        let lettersToGive = shuffleArray([...TARGET_LETTERS]); // Shuffle so they don't appear in order E-N-G...

        // Assign
        availableSlots.forEach((slot, i) => {
            if (i < lettersToGive.length) {
                // Handle potential duplicate slots (rare but possible), just overwrite or add next
                let key = `${slot.l}-${slot.q}`;
                rewardTriggers[key] = lettersToGive[i];
            }
        });
    }

    function initSpeech() {
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
        } else if ('SpeechRecognition' in window) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
        }
    }

    // --- HUD ---
    function renderHUD() {
        const hud = document.getElementById('hud-container');
        hud.innerHTML = '';
        // Create slots based on password length
        for(let i=0; i<TARGET_LETTERS.length; i++) {
            let div = document.createElement('div');
            div.id = `hud-${i}`;
            div.className = 'hud-slot';
            hud.appendChild(div);
        }
    }

    // --- GAME FLOW ---
    function startGame() {
        const nameInput = document.getElementById('start-player-name');
        const nameVal = nameInput.value.trim();
        if (!nameVal) {
            alert("Please enter your name!");
            nameInput.focus();
            return;
        }
        currentPlayerName = nameVal;
        document.getElementById('screen-start').classList.remove('active');
        document.getElementById('screen-game').classList.add('active');
        startTime = Date.now();
        timerInterval = setInterval(updateTimer, 1000);
        renderQuestion();
    }

    function updateTimer() {
        const now = Date.now();
        timeElapsed = Math.floor((now - startTime) / 1000);
        const m = Math.floor(timeElapsed / 60).toString().padStart(2, '0');
        const s = (timeElapsed % 60).toString().padStart(2, '0');
        document.getElementById('timer').innerText = `${m}:${s}`;
    }

    function renderQuestion() {
        const level = levels[currentLvlIdx];
        const qData = level.questions[currentQIdx];
        const container = document.getElementById('game-content');
        
        const indicator = document.getElementById('level-indicator');
        indicator.innerText = `${level.title} (${currentQIdx + 1}/${level.questions.length})`;
        indicator.className = `level-badge ${level.color}`;
        document.querySelector('.game-container').style.borderTopColor = `var(--${level.color.replace('bg-', 'g-')})`;

        let html = '';
        if (level.type === 'vocab') {
            html = `<div class="question-text">${qData.q}</div>
                <input type="text" id="vocab-input" placeholder="Type answer..." onkeyup="checkVocab('${qData.a}')" autocomplete="off">
                <div id="feedback" style="margin-top:10px; height: 30px; font-size:1.5rem; font-weight:bold;"></div>
                <button class="btn btn-next" id="next-btn" onclick="nextQuestion()">NEXT ü¶ñ</button>`;
        } else if (level.type === 'grammar') {
            html = `<div class="question-text">${qData.q}</div>`;
            qData.opts.forEach(opt => html += `<button class="btn btn-opt" onclick="checkGrammar('${opt}', '${qData.a}')">üëâ ${opt}</button>`);
        } else if (level.type === 'rearrange') {
            const shuffledChunks = shuffleArray([...qData.chunks]);
            html = `<div class="question-text">Rearrange chunks:</div>
                <div class="drop-zone" id="r-zone"></div>
                <div class="word-bank">${shuffledChunks.map(chunk => `<div class="word-chip" onclick="moveWord(this)">${chunk}</div>`).join('')}</div>
                <div style="margin-top: 30px;">
                    <button class="btn" style="background:#ddd" onclick="alert('HINT: ${qData.hint}')">üí° SOS</button>
                    <button class="btn bg-yellow" onclick="checkRearrange('${qData.correct}')">CHECK</button>
                </div>`;
        } else if (level.type === 'speaking') {
            html = `<div class="question-text">Read Aloud (>70%):</div>
                <div style="background:#eee; padding:20px; border-radius:10px; font-style:italic; font-size:1.8rem; color:var(--g-blue); margin-bottom:10px;">"${qData.text}"</div>
                <div class="mic-box" id="mic-btn" onclick="startRecording('${qData.text.replace(/'/g, "\\'")}')">üé§</div>
                <p id="rec-status" style="font-size:1.2rem;">Click mic to speak</p>
                <div class="speaking-result-box">
                    <div>You said: <span id="user-speech" style="color:#555">...</span></div>
                    <div style="margin-top:10px;">Accuracy: <span id="accuracy-score">0%</span></div>
                </div>
                <div id="fallback-area" style="margin-top:20px; display:none;"><button class="btn" style="background:#ccc; font-size:1.2rem;" onclick="simulatePass()">‚ö†Ô∏è Skip (Mic Error)</button></div>
                <button class="btn btn-next" id="speak-next" onclick="nextQuestion()">NEXT ü¶ñ</button>`;
        }
        container.innerHTML = html;
        if(level.type === 'vocab') document.getElementById('vocab-input').focus();
    }

    // --- LOGIC CHECKS ---
    function checkVocab(answer) {
        const input = document.getElementById('vocab-input');
        const btn = document.getElementById('next-btn');
        const feedback = document.getElementById('feedback');
        if (input.value.trim().toLowerCase() === answer.toLowerCase()) {
            input.style.borderColor = "var(--g-green)";
            feedback.innerHTML = "<span style='color:var(--g-green)'>CORRECT!</span>";
            btn.style.display = "inline-block";
        } else {
            input.style.borderColor = "#ccc";
            feedback.innerHTML = "";
            btn.style.display = "none";
        }
    }

    function checkGrammar(choice, answer) {
        if (choice === answer) nextQuestion();
        else alert("Oops! Try again. ü¶ñ");
    }

    function moveWord(el) {
        const zone = document.getElementById('r-zone');
        const bank = document.querySelector('.word-bank');
        if (el.parentElement === bank) zone.appendChild(el);
        else bank.appendChild(el);
    }

    function checkRearrange(correctSent) {
        const zone = document.getElementById('r-zone');
        const userSent = Array.from(zone.children).map(c => c.innerText).join(' ');
        const cleanUser = userSent.replace(/\.$/, "").trim();
        const cleanCorrect = correctSent.replace(/\.$/, "").trim();
        
        if (cleanUser === cleanCorrect) {
            alert("Correct! üéâ");
            nextQuestion();
        } else {
            alert("Not quite right. Check order!");
        }
    }

    // --- SPEAKING ---
    function startRecording(targetText) {
        const mic = document.getElementById('mic-btn');
        const status = document.getElementById('rec-status');
        const fallback = document.getElementById('fallback-area');
        if (!recognition) {
            fallback.style.display = 'block';
            return;
        }
        try {
            mic.classList.add('recording');
            status.innerText = "Listening...";
            recognition.start();
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                mic.classList.remove('recording');
                status.innerText = "Processing...";
                verifySpeech(transcript, targetText);
            };
            recognition.onerror = function(e) {
                mic.classList.remove('recording');
                status.innerText = "Error. Try again.";
                fallback.style.display = 'block';
            };
        } catch (e) { fallback.style.display = 'block'; }
    }

    function verifySpeech(transcript, target) {
        const accEl = document.getElementById('accuracy-score');
        const spkEl = document.getElementById('user-speech');
        const nextBtn = document.getElementById('speak-next');
        const status = document.getElementById('rec-status');

        spkEl.innerText = transcript;
        const sim = similarityRatio(transcript, target);
        const pct = Math.round(sim * 100);
        accEl.innerText = pct + "%";

        if (pct >= 70) {
            accEl.style.color = "var(--g-green)";
            status.innerText = "Pass!";
            status.style.color = "var(--g-green)";
            nextBtn.style.display = "inline-block";
        } else {
            accEl.style.color = "var(--g-red)";
            status.innerText = "Too low (<70%). Try again.";
            nextBtn.style.display = "none";
        }
    }
    
    function simulatePass() {
        document.getElementById('accuracy-score').innerText = "80% (Simulated)";
        document.getElementById('speak-next').style.display = "inline-block";
    }

    function similarityRatio(s1, s2) {
        let longer = s1.toLowerCase().replace(/[^a-z0-9]/g, "");
        let shorter = s2.toLowerCase().replace(/[^a-z0-9]/g, "");
        if (s1.length < s2.length) { longer = s2; shorter = s1; }
        if (longer.length === 0) return 1.0;
        return (longer.length - editDistance(longer, shorter)) / parseFloat(longer.length);
    }
    
    function editDistance(s1, s2) {
        const costs = new Array();
        for (let i = 0; i <= s1.length; i++) {
            let lastValue = i;
            for (let j = 0; j <= s2.length; j++) {
                if (i == 0) costs[j] = j;
                else if (j > 0) {
                    let newValue = costs[j - 1];
                    if (s1.charAt(i - 1) != s2.charAt(j - 1)) newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                    costs[j - 1] = lastValue;
                    lastValue = newValue;
                }
            }
            if (i > 0) costs[s2.length] = lastValue;
        }
        return costs[s2.length];
    }

    // --- NAVIGATION & REWARDS ---
    function nextQuestion() {
        const key = `${currentLvlIdx}-${currentQIdx}`;
        
        // Award letter?
        if (rewardTriggers[key]) {
            const letter = rewardTriggers[key];
            delete rewardTriggers[key]; // Consume reward
            unlockLetter(letter);
        } else {
            advanceLevel();
        }
    }

    function unlockLetter(char) {
        collectedLetters.push(char);
        
        // Visual Update HUD (find first empty slot)
        const slots = document.querySelectorAll('.hud-slot:not(.filled)');
        if(slots.length > 0) {
            slots[0].innerText = char;
            slots[0].classList.add('filled');
        }

        // Modal
        document.getElementById('reward-letter').innerText = char;
        document.getElementById('letter-modal').style.display = 'flex';
    }

    function closeLetterModal() {
        document.getElementById('letter-modal').style.display = 'none';
        advanceLevel();
    }

    function advanceLevel() {
        const level = levels[currentLvlIdx];
        if (currentQIdx < level.questions.length - 1) {
            currentQIdx++;
            renderQuestion();
        } else {
            if (currentLvlIdx < levels.length - 1) {
                currentLvlIdx++;
                currentQIdx = 0;
                renderQuestion();
            } else {
                startFinalPuzzle();
            }
        }
    }

    // --- FINAL PUZZLE ---
    function startFinalPuzzle() {
        // Teacher skip or missed letters guard
        if (collectedLetters.length < TARGET_LETTERS.length) {
            // Fill with remaining needed letters if any missing
            const needed = TARGET_LETTERS.length - collectedLetters.length;
            // Simply fill with random letters from password for simplicity in this edge case
            for(let i=0; i<needed; i++) collectedLetters.push(TARGET_LETTERS[i]);
        }

        puzzleBank = shuffleArray([...collectedLetters]);
        
        document.getElementById('screen-game').classList.remove('active');
        document.getElementById('screen-puzzle').classList.add('active');
        
        puzzleInput = [];
        renderPuzzle();
    }

    function renderPuzzle() {
        const slotContainer = document.getElementById('final-slots');
        let slotsHtml = '';
        for(let i=0; i<TARGET_LETTERS.length; i++) {
            const char = puzzleInput[i] ? puzzleInput[i] : '';
            slotsHtml += `<div class="puzzle-slot" onclick="removePuzzleChar(${i})">${char}</div>`;
        }
        slotContainer.innerHTML = slotsHtml;

        const bankContainer = document.getElementById('final-bank');
        bankContainer.innerHTML = puzzleBank.map((char, idx) => 
            `<div class="puzzle-letter" onclick="addPuzzleChar(${idx})">${char}</div>`
        ).join('');
        
        if (puzzleInput.length === TARGET_LETTERS.length) {
            const word = puzzleInput.join('');
            if (word === CURRENT_PASSWORD) {
                setTimeout(() => finishGame(), 300);
            }
        }
    }

    function addPuzzleChar(bankIdx) {
        if (puzzleInput.length < TARGET_LETTERS.length) {
            const char = puzzleBank[bankIdx];
            puzzleInput.push(char);
            puzzleBank.splice(bankIdx, 1);
            renderPuzzle();
        }
    }

    function removePuzzleChar(inputIdx) {
        if (puzzleInput[inputIdx]) {
            const char = puzzleInput[inputIdx];
            puzzleInput.splice(inputIdx, 1);
            puzzleBank.push(char);
            renderPuzzle();
        }
    }

    function resetPuzzle() {
        startFinalPuzzle();
    }

    function finishGame() {
        clearInterval(timerInterval);
        document.getElementById('screen-puzzle').classList.remove('active');
        document.getElementById('screen-end').classList.add('active');
        document.getElementById('final-time').innerText = document.getElementById('timer').innerText;
        document.getElementById('final-player-name').innerText = `Great Job, ${currentPlayerName}!`;
        document.getElementById('final-password-display').innerText = CURRENT_PASSWORD;
        saveScore();
    }

    // --- UTILS ---
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function saveScore() {
        const scores = JSON.parse(localStorage.getItem('finalExamScores') || '[]');
        scores.push({ name: currentPlayerName, time: timeElapsed, timeStr: document.getElementById('final-time').innerText });
        scores.sort((a, b) => a.time - b.time);
        localStorage.setItem('finalExamScores', JSON.stringify(scores.slice(0, 10)));
        loadLeaderboard();
    }

    function loadLeaderboard() {
        const scores = JSON.parse(localStorage.getItem('finalExamScores') || '[]');
        const table = document.getElementById('lb-table');
        if(scores.length === 0) { table.innerHTML = "<tr><td>No Data</td></tr>"; return; }
        let html = "<tr><th>RANK</th><th>NAME</th><th>TIME</th></tr>";
        scores.forEach((s, i) => {
            const isMe = (s.name === currentPlayerName && s.timeStr === document.getElementById('final-time').innerText);
            html += `<tr style="${isMe?'font-weight:bold;color:#4285F4':''}"><td>${i+1}</td><td>${s.name}</td><td>${s.timeStr}</td></tr>`;
        });
        table.innerHTML = html;
    }

    // --- ADMIN ---
    function openAdmin() {
        if (prompt("Password:") === "teacher123") {
            populateAdmin();
            document.getElementById('admin-pwd-display').innerText = CURRENT_PASSWORD;
            document.getElementById('admin-panel').style.display = 'block';
        }
    }
    function closeAdmin() { document.getElementById('admin-panel').style.display = 'none'; }
    
    function populateAdmin() {
        // Since levels are shuffled, we map the *current* levels array
        const l1 = document.getElementById('admin-l1');
        l1.innerHTML = levels[0].questions.map((q,i) => `<div class="admin-card" onclick="jumpTo(0,${i})"><b>${i+1}</b> ${q.a}</div>`).join('');
        const l2 = document.getElementById('admin-l2');
        l2.innerHTML = levels[1].questions.map((q,i) => `<div class="admin-card" onclick="jumpTo(1,${i})"><b>${i+1}</b> ${q.a}</div>`).join('');
        const l3 = document.getElementById('admin-l3');
        l3.innerHTML = levels[2].questions.map((q,i) => `<div class="admin-card" onclick="jumpTo(2,${i})"><b>${i+1}</b> ${q.correct.substring(0,10)}...</div>`).join('');
        const l4 = document.getElementById('admin-l4');
        l4.innerHTML = levels[3].questions.map((q,i) => `<div class="admin-card" onclick="jumpTo(3,${i})"><b>${i+1}</b> Speaking...</div>`).join('');
    }

    function jumpTo(l, q) {
        closeAdmin();
        currentLvlIdx = l; currentQIdx = q;
        document.getElementById('screen-start').classList.remove('active');
        document.getElementById('screen-end').classList.remove('active');
        document.getElementById('screen-game').classList.add('active');
        document.getElementById('screen-puzzle').classList.remove('active');
        if(!startTime) { startTime = Date.now(); timerInterval = setInterval(updateTimer,1000); }
        renderQuestion();
    }

    // Run Init
    init();

</script>
</body>
</html>